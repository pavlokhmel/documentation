<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to choose the number of cores &mdash; Sigma2 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nris.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/nris.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://siteimproveanalytics.com/js/siteanalyze_6036825.js"></script>
        <script src="../_static/design-tabs.js?v=36754332"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Common job failures" href="common_job_failures.html" />
    <link rel="prev" title="How to choose the right amount of memory" href="choosing-memory-settings.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sigma2/NRIS documentation
              <img src="../_static/NRIS Logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Policies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code-of-conduct.html">Code of Conduct</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/support_line.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/extended_support.html">Extended support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/user_communities.html">User communities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/lost_forgotten_password.html">Lost, expiring or changing passwords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/project_leader_support.html">Project leader support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../training/events.html">Training events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/notes_qa.html">Questions, Answers and Feedbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/videos.html">Training Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/material.html">Training materials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/opslog.html">Using the status system (opslog)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_account.html">How do I get an account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_development/guides/vs_code/connect_to_server.html">Connecting to a system with Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ssh.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/remote-desktop.html">Remote Desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/R.html">First R calculation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nird_archive/user-guide.html">Research Data Archive (NIRD RDA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/easydmp-user-documentation.html">EasyDMP User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HPC usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/migration2metacenter.html">Migration to an NRIS HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../computing/responsible-use.html">Using shared resources responsibly</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="overview.html">Running jobs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="submitting.html">Submitting jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="choosing_job_types.html">Job Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="job_scripts/array_jobs.html">Array Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="job_scripts.html">Job Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="slurm_output.html">Understanding the job output file</a></li>
<li class="toctree-l2"><a class="reference internal" href="choosing-memory-settings.html">How to choose the right amount of memory</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to choose the number of cores</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-it-matters">Why it matters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-arm-performance-reports">Using Arm Performance Reports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-top">Using top</a></li>
<li class="toctree-l3"><a class="reference internal" href="#timing-a-series-of-runs">Timing a series of runs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-seff">Using seff</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-jobstats">Using jobstats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#if-it-does-not-scale-what-can-be-possible-reasons">If it does not scale, what can be possible reasons?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-for-a-memory-bound-job">Example for a memory-bound job</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#what-is-mpi-and-openmp-and-how-can-i-tell">What is MPI and OpenMP and how can I tell?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-to-tell-if-the-code-is-using-one-of-the-two">How to tell if the code is using one of the two?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-r-matlab">Python/R/Matlab</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-may-call-a-library-which-is-shared-memory-parallelized">Code may call a library which is shared-memory parallelized</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="common_job_failures.html">Common job failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html">How to check the performance and scaling using Arm Performance Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="mkl.html">Using MKL efficiently</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory-bandwidth.html">Efficient use of memory bandwidth on Betzy</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel-calculations.html">Efficient use of processors and network on Betzy</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactive_jobs.html">Interactive jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="checkpointing.html">Checkpointing Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="projects_accounting.html">Projects and accounting</a></li>
<li class="toctree-l2"><a class="reference internal" href="scratchfiles.html">Local storage for scratch files</a></li>
<li class="toctree-l2"><a class="reference internal" href="guides.html">Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="slurm_commands.html">Useful Slurm commands and tools for managing jobs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../computing/tuning-applications.html">Tuning applications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code development and tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code_development/overview.html">Code development and tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../software/modulescheme.html">Software module scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/installed_software.html">Installed software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/licenses.html">Licence and access policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Files, storage and backup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird_lmd.html">NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/quota.html">Storage quota</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/performance.html">Optimizing storage performance</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sigma2/NRIS documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="overview.html">Running jobs</a></li>
      <li class="breadcrumb-item active">How to choose the number of cores</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/UNINETTSigma2/documentation/blob/main/jobs/choosing-number-of-cores.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-choose-the-number-of-cores">
<span id="choosing-number-of-cores"></span><h1><a class="toc-backref" href="#id1" role="doc-backlink">How to choose the number of cores</a><a class="headerlink" href="#how-to-choose-the-number-of-cores" title="Link to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>Asking for too few can lead to underused nodes or longer run time</p></li>
<li><p>Asking for too too many can mean wasted CPU resources</p></li>
<li><p>Asking for too much can mean a lot longer queuing</p></li>
</ul>
</div>
<nav class="contents" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#how-to-choose-the-number-of-cores" id="id1">How to choose the number of cores</a></p>
<ul>
<li><p><a class="reference internal" href="#why-it-matters" id="id2">Why it matters</a></p></li>
<li><p><a class="reference internal" href="#using-arm-performance-reports" id="id3">Using Arm Performance Reports</a></p></li>
<li><p><a class="reference internal" href="#using-top" id="id4">Using top</a></p></li>
<li><p><a class="reference internal" href="#timing-a-series-of-runs" id="id5">Timing a series of runs</a></p></li>
<li><p><a class="reference internal" href="#using-seff" id="id6">Using seff</a></p></li>
<li><p><a class="reference internal" href="#using-jobstats" id="id7">Using jobstats</a></p></li>
<li><p><a class="reference internal" href="#if-it-does-not-scale-what-can-be-possible-reasons" id="id8">If it does not scale, what can be possible reasons?</a></p>
<ul>
<li><p><a class="reference internal" href="#example-for-a-memory-bound-job" id="id9">Example for a memory-bound job</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#what-is-mpi-and-openmp-and-how-can-i-tell" id="id10">What is MPI and OpenMP and how can I tell?</a></p>
<ul>
<li><p><a class="reference internal" href="#how-to-tell-if-the-code-is-using-one-of-the-two" id="id11">How to tell if the code is using one of the two?</a></p></li>
<li><p><a class="reference internal" href="#python-r-matlab" id="id12">Python/R/Matlab</a></p></li>
<li><p><a class="reference internal" href="#code-may-call-a-library-which-is-shared-memory-parallelized" id="id13">Code may call a library which is shared-memory parallelized</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="why-it-matters">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Why it matters</a><a class="headerlink" href="#why-it-matters" title="Link to this heading"></a></h2>
<p>We request resources from the scheduler (queuing system).  But the scheduler
cannot tell how long the job will run and what resources it will really
consume.  Just the fact that I am asking the scheduler for 40 cores does not
mean that the code will actually run in parallel and use all of them.</p>
<p>Just because a website says that code X can run in parallel or “scales well”
does not mean that it will scale well for the particular feature/system/input
at hand.</p>
<p>Therefore <strong>it is important to verify and calibrate this setting</strong> for your use
case before computing very many similar jobs. Below we will show few
strategies.</p>
<p>Note that <strong>you don’t have to go through this for every single run</strong>. This is
just to calibrate a job type. If many of your jobs have similar resource
demands, then the calibration will probably be meaningful for all of them.</p>
</section>
<section id="using-arm-performance-reports">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Using Arm Performance Reports</a><a class="headerlink" href="#using-arm-performance-reports" title="Link to this heading"></a></h2>
<p>(This currently does not work because of network routing issues.  We are
working on restoring this.)</p>
</section>
<section id="using-top">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Using top</a><a class="headerlink" href="#using-top" title="Link to this heading"></a></h2>
<p>While the job is running, find out on which node(s) it runs using <code class="docutils literal notranslate"><span class="pre">squeue</span> <span class="pre">--me</span></code>,
then <code class="docutils literal notranslate"><span class="pre">ssh</span></code> into one of the listed compute nodes and run <code class="docutils literal notranslate"><span class="pre">top</span> <span class="pre">-u</span> <span class="pre">$USER</span></code>.</p>
<p>Some clusters also have <code class="docutils literal notranslate"><span class="pre">htop</span></code> available which produces similar output as <code class="docutils literal notranslate"><span class="pre">top</span></code>
but with colors and possibly clearer overview.</p>
</section>
<section id="timing-a-series-of-runs">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Timing a series of runs</a><a class="headerlink" href="#timing-a-series-of-runs" title="Link to this heading"></a></h2>
<p>Here is an example C code (<code class="docutils literal notranslate"><span class="pre">example.c</span></code>) which we can compile and test a bit:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">compute_something</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">my_rank</span><span class="p">;</span>
<span class="w">    </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_rank</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">my_values</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">buffer_recv</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">750</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">my_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_something</span><span class="p">(</span><span class="mi">1000</span><span class="o">/</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">MPI_Alltoall</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_values</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_recv</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">MPI_Finalize</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It does not matter so much what the code does. Here we wish to <strong>find out how
this code scales</strong> and what an optimum number of cores for it might be on our
system.</p>
<p>We can build our example binary with this script (<code class="docutils literal notranslate"><span class="pre">compile.sh</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="n">module</span> <span class="n">purge</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">foss</span><span class="o">/</span><span class="mi">2022</span><span class="n">b</span>

<span class="n">mpicc</span> <span class="n">example</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">o</span> <span class="n">mybinary</span> <span class="o">-</span><span class="n">lm</span>
</pre></div>
</div>
<p>Now take the following example script
(tested on Saga, please adapt the line containing <code class="docutils literal notranslate"><span class="pre">--account=nn____k</span></code> to reflect your project number):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="c1">#SBATCH --account=nn____k</span>

<span class="c1">#SBATCH --job-name=&#39;8-core&#39;</span>
<span class="c1">#SBATCH --time=0-00:10:00</span>
<span class="c1">#SBATCH --mem-per-cpu=1GB</span>
<span class="hll"><span class="c1">#SBATCH --ntasks=8</span>
</span><span class="hll"><span class="c1">#SBATCH -o 8.out</span>
</span>
<span class="n">module</span> <span class="n">purge</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">foss</span><span class="o">/</span><span class="mi">2022</span><span class="n">b</span>

<span class="n">time</span> <span class="n">srun</span> <span class="o">./</span><span class="n">mybinary</span>
</pre></div>
</div>
<p>Run a series of calculations on 1, 2, 4, 8, 16, 32, 64, and 128 cores.</p>
<p>You might get the following timings:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Number of cores</p></th>
<th class="head"><p>Time spent in mybinary</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>6m59.233s</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>3m33.082s</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>1m52.032s</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>0m58.532s</p></td>
</tr>
<tr class="row-even"><td><p>16</p></td>
<td><p>0m42.930s</p></td>
</tr>
<tr class="row-odd"><td><p>32</p></td>
<td><p>0m29.774s</p></td>
</tr>
<tr class="row-even"><td><p>64</p></td>
<td><p>0m46.347s</p></td>
</tr>
<tr class="row-odd"><td><p>128</p></td>
<td><p>1m52.461s</p></td>
</tr>
</tbody>
</table>
<p>Please try this. What can we conclude? And how can we explain it?</p>
</section>
<section id="using-seff">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Using seff</a><a class="headerlink" href="#using-seff" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">seff</span> <span class="pre">JOBID</span></code> is a nice tool which we can use on <strong>completed jobs</strong>.</p>
<p>Here we can compare the output from <code class="docutils literal notranslate"><span class="pre">seff</span></code> when using 4 cores and when using
8 cores.</p>
<p>Run with 4 cores:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Job</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5690604</span>
<span class="n">Cluster</span><span class="p">:</span> <span class="n">saga</span>
<span class="n">User</span><span class="o">/</span><span class="n">Group</span><span class="p">:</span> <span class="n">user</span><span class="o">/</span><span class="n">user</span>
<span class="n">State</span><span class="p">:</span> <span class="n">COMPLETED</span> <span class="p">(</span><span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Nodes</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Cores</span> <span class="n">per</span> <span class="n">node</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">CPU</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">39</span>
<span class="hll"><span class="n">CPU</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">75.00</span><span class="o">%</span> <span class="n">of</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">52</span> <span class="n">core</span><span class="o">-</span><span class="n">walltime</span>
</span><span class="hll"><span class="n">Job</span> <span class="n">Wall</span><span class="o">-</span><span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">13</span>
</span><span class="n">Memory</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mf">42.23</span> <span class="n">MB</span> <span class="p">(</span><span class="n">estimated</span> <span class="n">maximum</span><span class="p">)</span>
<span class="n">Memory</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">1.03</span><span class="o">%</span> <span class="n">of</span> <span class="mf">4.00</span> <span class="n">GB</span> <span class="p">(</span><span class="mf">1.00</span> <span class="n">GB</span><span class="o">/</span><span class="n">core</span><span class="p">)</span>
</pre></div>
</div>
<p>Run with 8 cores:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Job</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5690605</span>
<span class="n">Cluster</span><span class="p">:</span> <span class="n">saga</span>
<span class="n">User</span><span class="o">/</span><span class="n">Group</span><span class="p">:</span> <span class="n">user</span><span class="o">/</span><span class="n">user</span>
<span class="n">State</span><span class="p">:</span> <span class="n">COMPLETED</span> <span class="p">(</span><span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Nodes</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">Cores</span> <span class="n">per</span> <span class="n">node</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">CPU</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">45</span>
<span class="hll"><span class="n">CPU</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">56.25</span><span class="o">%</span> <span class="n">of</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">20</span> <span class="n">core</span><span class="o">-</span><span class="n">walltime</span>
</span><span class="hll"><span class="n">Job</span> <span class="n">Wall</span><span class="o">-</span><span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">10</span>
</span><span class="n">Memory</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mf">250.72</span> <span class="n">MB</span> <span class="p">(</span><span class="n">estimated</span> <span class="n">maximum</span><span class="p">)</span>
<span class="n">Memory</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">3.06</span><span class="o">%</span> <span class="n">of</span> <span class="mf">8.00</span> <span class="n">GB</span> <span class="p">(</span><span class="mf">1.00</span> <span class="n">GB</span><span class="o">/</span><span class="n">core</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-jobstats">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Using jobstats</a><a class="headerlink" href="#using-jobstats" title="Link to this heading"></a></h2>
<p>Try it with one of your jobs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>jobstats<span class="w"> </span>-j<span class="w"> </span><span class="m">12345</span>
</pre></div>
</div>
</section>
<section id="if-it-does-not-scale-what-can-be-possible-reasons">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">If it does not scale, what can be possible reasons?</a><a class="headerlink" href="#if-it-does-not-scale-what-can-be-possible-reasons" title="Link to this heading"></a></h2>
<p>Here are typical problems:</p>
<ul class="simple">
<li><p>At some point more time is spent communicating than computing</p></li>
<li><p>Memory-bound jobs saturate the memory bandwidth</p></li>
<li><p>At some point the non-parallelized code section dominates the compute time (<a class="reference external" href="https://en.wikipedia.org/wiki/Amdahl%27s_law">Amdahl’s law</a>)</p></li>
</ul>
<section id="example-for-a-memory-bound-job">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Example for a memory-bound job</a><a class="headerlink" href="#example-for-a-memory-bound-job" title="Link to this heading"></a></h3>
<p>Here is an example Fortran code (<code class="docutils literal notranslate"><span class="pre">example.f90</span></code>) which we can compile and test a bit:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">integer </span><span class="k">function </span><span class="n">random_integer</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span><span class="w"> </span><span class="n">upper_bound</span><span class="p">)</span>

<span class="w">    </span><span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lower_bound</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">upper_bound</span>

<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">f</span>

<span class="w">    </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="w">    </span><span class="n">random_integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_bound</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">floor</span><span class="p">((</span><span class="n">upper_bound</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lower_bound</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">)</span>

<span class="k">end function</span>


<span class="k">program </span><span class="n">example</span>

<span class="w">    </span><span class="k">implicit none</span>

<span class="w">    </span><span class="c">! adjust these</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">size_mb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1900</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">num_rounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500000000</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">size_mw</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">external</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">random_integer</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(:)</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iround</span><span class="p">,</span><span class="w"> </span><span class="n">iposition</span>

<span class="w">    </span><span class="n">size_mw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">1000000</span><span class="o">*</span><span class="n">size_mb</span><span class="o">/</span><span class="mf">7.8125d0</span><span class="p">)</span>
<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">size_mw</span><span class="p">))</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span>

<span class="w">    </span><span class="k">do </span><span class="n">iround</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">num_rounds</span>
<span class="w">        </span><span class="n">iposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random_integer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size_mw</span><span class="p">)</span>
<span class="w">        </span><span class="n">a</span><span class="p">(</span><span class="n">iposition</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">iposition</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0d0</span>
<span class="w">    </span><span class="k">end do</span>

<span class="k">    deallocate</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ok all went fine&#39;</span>

<span class="k">end program</span>
</pre></div>
</div>
<p>We can build our example binary with this script (<code class="docutils literal notranslate"><span class="pre">compile.sh</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="n">module</span> <span class="n">load</span> <span class="n">foss</span><span class="o">/</span><span class="mi">2020</span><span class="n">b</span>

<span class="n">gfortran</span> <span class="n">example</span><span class="o">.</span><span class="n">f90</span> <span class="o">-</span><span class="n">o</span> <span class="n">mybinary</span>
</pre></div>
</div>
<p>Now take the following example script
(adapt <code class="docutils literal notranslate"><span class="pre">--account=nn____k</span></code>; this is tested on Saga):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --account=nn____k</span>
<span class="c1">#SBATCH --qos=devel</span>

<span class="c1">#SBATCH --job-name=&#39;mem-bandwidth&#39;</span>
<span class="c1">#SBATCH --time=0-00:02:00</span>
<span class="c1">#SBATCH --mem-per-cpu=2000M</span>
<span class="c1">#SBATCH --ntasks=1</span>

<span class="n">module</span> <span class="n">purge</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">foss</span><span class="o">/</span><span class="mi">2020</span><span class="n">b</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">Arm</span><span class="o">-</span><span class="n">Forge</span><span class="o">/</span><span class="mf">21.1</span>

<span class="n">perf</span><span class="o">-</span><span class="n">report</span> <span class="o">./</span><span class="n">mybinary</span>
</pre></div>
</div>
<p>This will generate the following performance report:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">Summary</span><span class="p">:</span> <span class="n">mybinary</span> <span class="ow">is</span> <span class="n">Compute</span><span class="o">-</span><span class="n">bound</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">configuration</span>
<span class="hll"><span class="n">Compute</span><span class="p">:</span>                                    <span class="mf">100.0</span><span class="o">%</span> <span class="o">|=========|</span>
</span><span class="n">MPI</span><span class="p">:</span>                                          <span class="mf">0.0</span><span class="o">%</span> <span class="o">|</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="p">:</span>                                          <span class="mf">0.0</span><span class="o">%</span> <span class="o">|</span>
<span class="n">This</span> <span class="n">application</span> <span class="n">run</span> <span class="n">was</span> <span class="n">Compute</span><span class="o">-</span><span class="n">bound</span><span class="o">.</span> <span class="n">A</span> <span class="n">breakdown</span> <span class="n">of</span> <span class="n">this</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">advice</span> <span class="k">for</span>
<span class="n">investigating</span> <span class="n">further</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">CPU</span> <span class="n">section</span> <span class="n">below</span><span class="o">.</span>  <span class="n">As</span> <span class="n">very</span> <span class="n">little</span> <span class="n">time</span> <span class="ow">is</span>
<span class="n">spent</span> <span class="ow">in</span> <span class="n">MPI</span> <span class="n">calls</span><span class="p">,</span> <span class="n">this</span> <span class="n">code</span> <span class="n">may</span> <span class="n">also</span> <span class="n">benefit</span> <span class="kn">from</span> <span class="nn">running</span> <span class="n">at</span> <span class="n">larger</span> <span class="n">scales</span><span class="o">.</span>

<span class="n">CPU</span><span class="p">:</span>
<span class="n">A</span> <span class="n">breakdown</span> <span class="n">of</span> <span class="n">the</span> <span class="mf">100.0</span><span class="o">%</span> <span class="n">CPU</span> <span class="n">time</span><span class="p">:</span>
<span class="n">Scalar</span> <span class="n">numeric</span> <span class="n">ops</span><span class="p">:</span>                           <span class="mf">4.4</span><span class="o">%</span> <span class="o">||</span>
<span class="n">Vector</span> <span class="n">numeric</span> <span class="n">ops</span><span class="p">:</span>                           <span class="mf">0.0</span><span class="o">%</span> <span class="o">|</span>
<span class="hll"><span class="n">Memory</span> <span class="n">accesses</span><span class="p">:</span>                             <span class="mf">91.6</span><span class="o">%</span> <span class="o">|========|</span>
</span><span class="n">The</span> <span class="n">per</span><span class="o">-</span><span class="n">core</span> <span class="n">performance</span> <span class="ow">is</span> <span class="n">memory</span><span class="o">-</span><span class="n">bound</span><span class="o">.</span> <span class="n">Use</span> <span class="n">a</span> <span class="n">profiler</span> <span class="n">to</span> <span class="n">identify</span>
<span class="n">time</span><span class="o">-</span><span class="n">consuming</span> <span class="n">loops</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">their</span> <span class="n">cache</span> <span class="n">performance</span><span class="o">.</span>  <span class="n">No</span> <span class="n">time</span> <span class="ow">is</span> <span class="n">spent</span> <span class="ow">in</span>
<span class="n">vectorized</span> <span class="n">instructions</span><span class="o">.</span> <span class="n">Check</span> <span class="n">the</span> <span class="n">compiler</span><span class="s1">&#39;s vectorization advice to see why</span>
<span class="n">key</span> <span class="n">loops</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">vectorized</span><span class="o">.</span>

<span class="o">...</span>
</pre></div>
</div>
<p>How do you interpret this result? Will it help to buy faster processors? What
limitations can you imagine when running this on many cores on the same node?</p>
</section>
</section>
<section id="what-is-mpi-and-openmp-and-how-can-i-tell">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">What is MPI and OpenMP and how can I tell?</a><a class="headerlink" href="#what-is-mpi-and-openmp-and-how-can-i-tell" title="Link to this heading"></a></h2>
<p>These two parallelization schemes are very common (but there are other schemes):</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Message_Passing_Interface">Message passing interface</a>:
typically each task allocates its own memory, tasks communicate via messages,
and it is no problem to go beyond one node.</p></li>
<li><p><a class="reference external" href="https://www.openmp.org/">OpenMP</a>:
threads share memory and communicate through memory, and we cannot go beyond one node.</p></li>
</ul>
<section id="how-to-tell-if-the-code-is-using-one-of-the-two">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">How to tell if the code is using one of the two?</a><a class="headerlink" href="#how-to-tell-if-the-code-is-using-one-of-the-two" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>If you wrote the software: then you probably know</p></li>
<li><p>If it is written by somebody else:</p>
<ul>
<li><p>It can be difficult to tell</p></li>
<li><p>Consult manual for the software or contact support (theirs or ours)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">mpi</span></code> and <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">&quot;omp</span> <span class="pre">&quot;</span></code> the source code</p></li>
<li><p>Example: <a class="reference external" href="https://github.com/MRChemSoft/mrchem">https://github.com/MRChemSoft/mrchem</a> (uses both MPI and OpenMP)</p></li>
</ul>
</li>
</ul>
</section>
<section id="python-r-matlab">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Python/R/Matlab</a><a class="headerlink" href="#python-r-matlab" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Often not parallelized</p></li>
<li><p>But can use parallelization (e.g. <code class="docutils literal notranslate"><span class="pre">mpi4py</span></code> or <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>)</p></li>
</ul>
</section>
<section id="code-may-call-a-library-which-is-shared-memory-parallelized">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Code may call a library which is shared-memory parallelized</a><a class="headerlink" href="#code-may-call-a-library-which-is-shared-memory-parallelized" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Examples: BLAS libraries, NumPy, SciPy</p></li>
</ul>
<p>Here is an example which you can try (<code class="docutils literal notranslate"><span class="pre">example.py</span></code>) where we compute a couple
of matrix-matrix multiplications using Numpy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># run it multiple times, just so that it runs longer and we have enough time to</span>
<span class="c1"># inspect it while it&#39;s running</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">matrix_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">matrix_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="n">matrix_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">matrix_a</span><span class="p">,</span> <span class="n">matrix_b</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calculation completed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It can be interesting to try this example with the following run script (adapt <code class="docutils literal notranslate"><span class="pre">--account=nn____k</span></code>; this is tested on Saga):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="c1">#SBATCH --account=nn____k</span>

<span class="c1">#SBATCH --job-name=&#39;example&#39;</span>
<span class="c1">#SBATCH --time=0-00:02:00</span>
<span class="c1">#SBATCH --mem-per-cpu=1500M</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --tasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=4</span>

<span class="n">module</span> <span class="n">load</span> <span class="n">SciPy</span><span class="o">-</span><span class="n">bundle</span><span class="o">/</span><span class="mf">2023.02</span><span class="o">-</span><span class="n">gfbf</span><span class="o">-</span><span class="mi">2022</span><span class="n">b</span>

<span class="hll"><span class="c1"># export MKL_NUM_THREADS=$OMP_NUM_THREADS</span>
</span><span class="hll"><span class="c1"># export NUMEXPR_NUM_THREADS=$OMP_NUM_THREADS</span>
</span>
<span class="n">python</span> <span class="n">example</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Run this example and check the timing. Then uncomment the highlighted lines and
run it again and compare timings.  It can also be interesting to log into the
compute node while the job is running and using <code class="docutils literal notranslate"><span class="pre">top</span> <span class="pre">-u</span> <span class="pre">$USER</span></code>. Can you explain
what is happening here?</p>
<p>Here is a comparison of the two runs using <code class="docutils literal notranslate"><span class="pre">seff</span></code> and the corresponding job numbers:</p>
<p>This was the job script where the export lines were commented:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Job</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5690632</span>
<span class="n">Cluster</span><span class="p">:</span> <span class="n">saga</span>
<span class="n">User</span><span class="o">/</span><span class="n">Group</span><span class="p">:</span> <span class="n">user</span><span class="o">/</span><span class="n">user</span>
<span class="n">State</span><span class="p">:</span> <span class="n">COMPLETED</span> <span class="p">(</span><span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Nodes</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Cores</span> <span class="n">per</span> <span class="n">node</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">CPU</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">32</span>
<span class="hll"><span class="n">CPU</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">22.12</span><span class="o">%</span> <span class="n">of</span> <span class="mi">00</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">56</span> <span class="n">core</span><span class="o">-</span><span class="n">walltime</span>
</span><span class="hll"><span class="n">Job</span> <span class="n">Wall</span><span class="o">-</span><span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">44</span>
</span><span class="n">Memory</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mf">789.23</span> <span class="n">MB</span>
<span class="n">Memory</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">13.15</span><span class="o">%</span> <span class="n">of</span> <span class="mf">5.86</span> <span class="n">GB</span>
</pre></div>
</div>
<p>And this was the job script with the export lines active:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Job</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">5690642</span>
<span class="n">Cluster</span><span class="p">:</span> <span class="n">saga</span>
<span class="n">User</span><span class="o">/</span><span class="n">Group</span><span class="p">:</span> <span class="n">user</span><span class="o">/</span><span class="n">user</span>
<span class="n">State</span><span class="p">:</span> <span class="n">COMPLETED</span> <span class="p">(</span><span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Nodes</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Cores</span> <span class="n">per</span> <span class="n">node</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">CPU</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">32</span>
<span class="hll"><span class="n">CPU</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">74.19</span><span class="o">%</span> <span class="n">of</span> <span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">04</span> <span class="n">core</span><span class="o">-</span><span class="n">walltime</span>
</span><span class="hll"><span class="n">Job</span> <span class="n">Wall</span><span class="o">-</span><span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">31</span>
</span><span class="n">Memory</span> <span class="n">Utilized</span><span class="p">:</span> <span class="mf">797.02</span> <span class="n">MB</span>
<span class="n">Memory</span> <span class="n">Efficiency</span><span class="p">:</span> <span class="mf">13.28</span><span class="o">%</span> <span class="n">of</span> <span class="mf">5.86</span> <span class="n">GB</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="choosing-memory-settings.html" class="btn btn-neutral float-left" title="How to choose the right amount of memory" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="common_job_failures.html" class="btn btn-neutral float-right" title="Common job failures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Sigma2/NRIS. Text shared under CC-BY 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<!-- Integrate opslog banner -->
<span class="sp-status"></span>
<script>
  window.statuspalWidget = {
    subdomain: 'sigma2-nris',
    host: 'https://statuspal.eu',
    badge: {
      enabled: false,
      selector: '.sp-status', 
    },
    banner: {
      enabled: true,
      position: 'top-right',
    }
  }
</script>
<script src="https://statuspal.io/js/widget.js"></script>


</body>
</html>